# Storage API
API to upload, view, download and delete objects in cloud storage. Used to store data about jobs.

Data is represented as a byte slice (`[]byte`), a `Location` defines _where_ the data object is stored, it has a bucket name and an object name:
```
type Location struct {
	Bucket string `json:"bucket"`
	Object string `json:"object"`
}
```

See [storage_integration_test.go](storage_integration_test.go) for full set of use cases, to follow is a basic user guide to get started.

# Create new cloud storage client
Create client for given bucket:
```
client, err := NewClient("[unique-project-bucket-name]")
if err != nil {
    log.Fatal("Could not create storage client", err)
}
```

# Creating locations

## Create new Location
Create reference to Object location: `gs://[bucket name]/[object]`:
```
location := Location{Bucket: "[bucket name]", Object: "[object]" }
```
or
```
location := NewLocation{"[bucket name]", "[object]")
```
e.g. create object reference `gs://project-123-bucket/my/path/object_name`:
```
location := NewLocation{"project-123-bucket", "my/path/object_name")
```

## AUto-generate unique object name for given bucket and path
Create reference to Object location: `gs://[bucket name]/[path]/[unique ID]`:
```
location = NewWithAutoGeneratedName("[bucket name]", "[path]") 
```
e.g. create object reference `gs://project-123-bucket/my/path/[unique ID]`:
```
location := NewWithAutoGeneratedName{"project-123-bucket", "my/path")
```

# Upload
Upload data:
```
data := []byte("payload")
err = client.Upload(location, data)
if err != nil {
   log.Fatal("Could not upload data", err)
}
```

# Download
Download data:
```
download, err := client.Download(location)
if err != nil {
   log.Fatal("Could not download data", err)
}
```

# View
View data uploaded to a cloud storage bucket using `ListObjects`:
```
client, _ = NewClient()
bucket := BucketNameFromEnv()
path := "view/test"
// upload some data
client.Upload(NewLocationWithAutoGeneratedName(bucket, path), []byte("payload 1"))
client.Upload(NewLocationWithAutoGeneratedName(bucket, path), []byte("payload 2"))
// list objects at gs://[bucket]/view/test/
objs, _ := client.ListObjects(NewLocation(bucket, path))
for _, obj := range objs {
   fmt.Println(obj)
}
```
Expect to see something like below, which prints out name of object, its size, and when created:
```
{view/test/c02pdf8bigpejme70jq0 9 2021-01-18 14:10:05.565 +0000 UTC}
{view/test/c02pdsgbigpemi9u0k1g 9 2021-01-18 14:10:58.006 +0000 UTC}
```

Alternatively, use `ForEachObject`, which provides access to _all_ object attributes
```
client.ForEachObject(NewLocation(bucket, path), func(attrs *storage.ObjectAttrs) error {
  fmt.Println(attrs)
	return nil
})
```

# Delete
Delete an object:
```
err = client.Delete(location)
if err != nil {
   log.Errorf("Could not delete object at %q, error: %v", location, err)
}
```    

# Integration Test
See [storage_integration_test.go](storage_integration_test.go) 

## Set-up - create cloud storage bucket
One off task to create bucket, test will upload objects into bucket, and delete data before exit
```
export CLOUD_STORAGE_BUCKET_NAME=[bucket name]
gsutil mb gs://${CLOUD_STORAGE_BUCKET_NAME}
```

## Run test
```
export CLOUD_STORAGE_BUCKET_NAME=[bucket name]
export GOOGLE_APPLICATION_CREDENTIALS=${HOME}/integration_test_key.json
go test -v
```
See [iam/README.md](../../iam/README.md) for info on creaitng the service account key 